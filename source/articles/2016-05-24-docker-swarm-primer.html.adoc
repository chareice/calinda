---
title: Docker Swarm åˆä½“éªŒ
date: 2016-05-24 13:29 UTC
tags:
online: true
---

:toc: macro
:toc-title: æœ¬æ–‡ç›®å½•
:toclevels: 1
:numbered:

toc::[]

https://www.docker.com/products/docker-swarm[Docker Swarm]æ˜¯Dockerå®˜æ–¹æ¨å‡ºçš„å¤šæœºDockeré›†ç¾¤å·¥å…·ï¼Œå®ƒå°†ä¸€ç»„ç‹¬ç«‹çš„DockeræœåŠ¡æŠ½è±¡ä¸ºä¸€ä¸ªå•ç‹¬çš„è™šæ‹ŸDockeræœåŠ¡ï¼Œå¹¶ä¸”è¿™å’Œè™šæ‹Ÿçš„DockeræœåŠ¡å¯ä»¥å’Œå‡ ä¹æ‰€æœ‰çš„Dockerå®¢æˆ·ç«¯å…¼å®¹ã€‚

== Docker Swarm

è¦å®‰è£…Docker Swarmï¼Œé¦–å…ˆå¾—ç†è§£swarmçš„åˆ›å»ºæ–¹æ³•ï¼Œè¦åˆ›å»º swarm ç½‘ç»œçš„ç¬¬ä¸€æ­¥æ˜¯æ‹‰å–Docker Swarmé•œåƒï¼Œç„¶åä½¿ç”¨Dockeræ¥è®¾ç½®swarm managerå’Œæ‰€æœ‰åœ¨swarmä¸­è¿è¡Œçš„èŠ‚ç‚¹ã€‚è¿™äº›æ–¹æ³•è¦æ±‚ä½ ï¼š

* åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰“å¼€ä¸€ä¸ªå’Œswarm manageré€šä¿¡çš„TCPç«¯å£
* åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Docker
* å®‰è£…å’Œç®¡ç†TLSè¯ä¹¦æ¥ä¿è¯swarmé€šä¿¡å®‰å…¨

å¦‚æœæ˜¯è¦åˆæ¬¡ä½“éªŒswarmï¼Œå®˜æ–¹æ¨èä½¿ç”¨docker-machineæ¥å®‰è£…swarmã€‚

=== Docker Machineå®‰è£…Docker Swarm

å®‰è£…å¥½docker-machineä¹‹åï¼Œæˆ‘ä»¬å°è¯•å¯åŠ¨ä¸‰å°èŠ‚ç‚¹(node)ã€‚

==== æ‰“å¼€ç»ˆç«¯ï¼Œæ˜¾ç¤ºç°æœ‰çš„è™šæ‹Ÿæœºåˆ—è¡¨ã€‚

```text
âœ  ~ docker-machine ls
NAME   ACTIVE   DRIVER         STATE     URL   SWARM
dev    -        vmwarefusion   Stopped
```
==== åˆ›å»ºä¸€å°åå« `manager` çš„è™šæ‹Ÿæœºã€‚

```text
âœ  ~ docker-machine create -d virtualbox manager
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env manager
```

==== åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå« `agent1` ã€‚

```
âœ  ~ docker-machine create -d virtualbox agent1
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent1
```

==== åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå« `agent2` ã€‚

```
âœ  ~ docker-machine create -d virtualbox agent2
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent2
```

=== åˆ›å»º Swarm discovery token

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨Docker Hubæ‰˜ç®¡çš„discoveryåç«¯æ¥ä¸ºæˆ‘ä»¬çš„é›†ç¾¤ç”Ÿæˆä¸€ä¸ªå…¨çƒå”¯ä¸€çš„discovery tokenã€‚è¿™ä¸ªdiscoveryåç«¯ä»…ä»…ç”¨åšå¼€å‘å’Œæµ‹è¯•æ„å›¾ï¼Œå¹¶ä¸æ˜¯é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒã€‚ç¨åï¼Œå½“ä½ è¿è¡Œswarm managerå’Œnodesï¼Œå®ƒä»¬ä¼šåœ¨discoveryåç«¯æ³¨å†Œä¸ºé›†ç¾¤çš„æˆå‘˜ï¼Œè¿™ä¸ªé›†ç¾¤æ­£æ˜¯å’Œåˆšæ‰è·å–åˆ°çš„discovery tokenå…³è”çš„ã€‚discoveryåç«¯ç»´æŠ¤å’Œç®¡ç†è¯¥é›†ç¾¤ä¸­çš„æˆå‘˜åˆ—è¡¨ï¼Œå¹¶å’Œswarm managerå…±äº«åˆ—è¡¨å†…å®¹ï¼Œ swarm managerä½¿ç”¨è¿™ä¸ªåˆ—è¡¨æ¥ç»™nodesåˆ†é…ä»»åŠ¡ã€‚

==== è¿æ¥åˆ°manager docker engineã€‚

```text
âœ  ~ eval $(docker-machine env manager)
```

==== ä¸ºswarmé›†ç¾¤åˆ›å»ºå”¯ä¸€idã€‚

ç”±äºä½ æ‡‚çš„åŸå› ï¼Œè¿™é‡Œä½¿ç”¨alaudaçš„é•œåƒæ¥æ›¿ä»£swarmé•œåƒã€‚

```text
âœ  ~ docker run --rm index.alauda.cn/library/swarm create
Unable to find image 'index.alauda.cn/library/swarm:latest' locally
latest: Pulling from library/swarm
4bdde9413a9d: Pull complete
281a124ed91f: Pull complete
d953790d1cd9: Pull complete
73f6bd4c8155: Pull complete
4be7977a13c8: Pull complete
a7afc66291b2: Pull complete
6abeb218f75c: Pull complete
9a6aaea664d1: Pull complete
Digest: sha256:7daa83d26095e5761252cfc0d8cb6f5e04a9443654ed3fc4395cb9ce3709730a
Status: Downloaded newer image for index.alauda.cn/library/swarm:latest
e93a2623b23255f245ee82fb9617320e
```

==== å¤åˆ¶å”¯ä¸€idã€‚

å”¯ä¸€IDå°±æ˜¯ä¸Šä¸€æ­¥å‘½ä»¤æœ€åä¸€è¡Œå­—ä»˜ä¸²ã€‚

== åˆ›å»ºSwarm managerå’Œnodes

è¿™ä¸€æ­¥ï¼Œä½ å°†æŠŠæ¯ä¸€ä¸ªä¸»æœºè¿æ¥èµ·æ¥ï¼Œå¹¶ä¸”åˆ›å»ºswarm managerå’Œnodesã€‚

=== æŸ¥çœ‹è¿è¡Œä¸­çš„è™šæ‹Ÿæœºåˆ—è¡¨ã€‚

```text
âœ  ~ docker-machine ls
NAME      ACTIVE   DRIVER         STATE     URL                         SWARM
agent1    -        virtualbox     Running   tcp://192.168.99.101:2376
agent2    -        virtualbox     Running   tcp://192.168.99.102:2376
dev       -        vmwarefusion   Stopped
manager   *        virtualbox     Running   tcp://192.168.99.100:2376
```

ä½ çš„Dockerå®¢æˆ·ç«¯è¿˜æ˜¯åº”å½“è¿æ¥åˆ°managerèŠ‚ç‚¹ã€‚ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•åœ¨ `manager` ä¸»æœºä¸Šè¿è¡Œä¸€ä¸ªåŠŸèƒ½ä¸ºprimary managerçš„å®¹å™¨ã€‚

```text
âœ  ~ docker run -d -p <ä½ é€‰æ‹©çš„ç«¯å£å·>:3376 -t -v /var/lib/boot2docker:/certs:ro swarm manage -H 0.0.0.0:3376 --tlsverify --tlscacert=/certs/ca.pem --tlscert=/certs/server.pem --tlskey=/certs/server-key.pem token://e93a2623b23255f245ee82fb9617320e
```

=== è¿æ¥åˆ°`agent1`ã€‚

```text
âœ  ~ eval $(docker-machine env agent1)
```

=== åœ¨`agent1`ä¸»æœºä¸Šè¿è¡ŒåŠŸèƒ½ä¸ºagentçš„å®¹å™¨ã€‚

```text
âœ  ~ docker run -d index.alauda.cn/library/swarm:latest join --addr=$(docker-machine ip agent1):2376 token://e93a2623b23255f245ee82fb9617320e
```

=== è¿æ¥åˆ°`agent2`ï¼Œé‡å¤åŒæ ·çš„å‘½ä»¤ï¼Œæ³¨æ„æ›¿æ¢IPåœ°å€ã€‚

== ç®¡ç†ä½ çš„Swarm

åœ¨è¿™é‡Œï¼Œä½ å°†è¿æ¥ä¸Šä½ åˆ›å»ºçš„é›†ç¾¤ï¼ŒæŸ¥çœ‹swarm managerå’Œnodesçš„ä¿¡æ¯ï¼Œé€šçŸ¥swarnè¿è¡Œå®¹å™¨ç„¶åæ£€æŸ¥æ˜¯å“ªä¸ªèŠ‚ç‚¹è¿è¡Œäº†è¿™ä¸ªå®¹å™¨ã€‚

=== é€šè¿‡ä¿®æ”¹`DOCKER_HOST`ç¯å¢ƒå˜é‡è¿æ¥åˆ°swarmã€‚

```text
âœ  ~ DOCKER_HOST=<manager_ip>:<ä½ é€‰æ‹©çš„ç«¯å£å·>
```

=== æŸ¥çœ‹swarmçš„ä¿¡æ¯ã€‚

```text
âœ  ~ docker info
```

åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯ã€‚å®˜æ–¹æ–‡æ¡£è¯´èƒ½çœ‹åˆ°2ä¸ªagentå’Œ1ä¸ªmasterï¼Œå¯æ˜¯æˆ‘åªçœ‹åˆ°äº†2ä¸ªagent...ğŸ˜“

=== æŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨ã€‚

```text
âœ  ~ docker ps
```

=== åœ¨swarmä¸­è¿è¡Œå®¹å™¨ã€‚

```text
âœ  ~ docker run index.alauda.cn/library/hello-world
```

=== ä½¿ç”¨ `docker ps` æŸ¥çœ‹å®¹å™¨è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker Swarmä½¿ç”¨'spread'è°ƒåº¦ç­–ç•¥æ¥è¿è¡Œå®¹å™¨ï¼Œè¯¥ç­–ç•¥ä¼šé€‰æ‹©è¿è¡Œå®¹å™¨æ•°é‡æœ€å°‘çš„hostæ¥è¿è¡Œå®¹å™¨ã€‚
