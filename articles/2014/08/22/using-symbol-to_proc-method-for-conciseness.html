<!DOCTYPE html><html><head><title>ruby迭代map简便写法的实现原理 - Hi, I'm Chareice.</title><meta charset=UTF-8 /><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name=viewport /><link href="/images/favicon.ico" rel="shortcut icon"/><link href="/stylesheets/index.css" rel=stylesheet /><link href="//dn-chareicecnd.qbox.me/solarized_dark.css" rel=stylesheet /></head><body><header><a href="/" id=go-back-home><img alt=Home height=100 src="/images/blog_logo.png" width=100 /></a><p>Hi, I'm Chareice.</p><p>很高兴见到你</p></header><div id=container><div class=block><a href="/articles/tags/rabbitmq.html">RabbitMQ</a><a href="/articles/tags/java.html">Java</a><a href="/articles/tags/算法.html">算法</a><a href="/articles/tags/计算机科学基础.html">计算机科学基础</a><a href="/articles/tags/python.html">Python</a><a href="/articles/tags/ruby.html">Ruby</a><a href="/articles/tags/rails.html">Rails</a></div><div class=content><section class=post><header><div class=date>22 Aug 2014</div><h1>ruby迭代map简便写法的实现原理</h1></header><h2>简便方法的用法</h2> <p>现有一个字符串列表，需要对其中的每个字符串执行转换大写操作，我们可以用一个简便写法来完成。</p> <pre><code class="ruby">name_list = [&quot;chareice&quot;, &quot;angel&quot;]
name_list.map(&amp;:upcase)
# =&gt; [&quot;CHAREICE&quot;, &quot;ANGEL&quot;]
</code></pre> <p>这个写法等同于</p> <pre><code class="ruby">name_list.map do {|name| name.upcase}
</code></pre> <p>简便写法带来的是很明显的效率提升，可是这看似魔术一般的参数，背后的原理是怎样的呢？</p> <h2>&amp;符号</h2> <p>如果把上面方法调用的<code>&amp;</code>符号去掉，可以很明显得看到，是把<code>:upcase</code>这个符号传到方法中，作为方法的参数。</p> <p>实际上，<code>&amp;</code>符号代表的是<strong>块转变为Proc(block-to-proc conversion)</strong>。我们看下面的一个例子。</p> <pre><code class="ruby">def capture_block(&amp;block)
  block.call
end

capture_block { puts &quot;我有一只小毛驴，我从来也不骑。&quot; }
# =&gt; 我有一只小毛驴，我从来也不骑。
</code></pre> <p>我们运行<code>capture_block</code>函数，给它传递一个代码块，代码块会经<code>&amp;</code>符号的转换变为一个<code>Proc</code>对象传递到函数中，在上面的例子中就是<code>block</code>变量。如果我们输出一下<code>block</code>的class，输出的结果会是<code>Proc</code>。</p> <p>你也可以将一个<code>Proc</code>对象传递给<code>capture_block</code>来代替代码块.</p> <pre><code class="ruby">p = Proc.new { puts &quot;又给一只小毛驴&quot; }
capture_block(&amp;p)
# =&gt; 又给一只小毛驴
</code></pre> <p>这里看来<code>&amp;</code>符号是多余的，完全可以去掉<code>&amp;</code>，运行的结果也是一样。</p> <h3><code>&amp;</code>符号做了什么?</h3> <p>以<code>capture_block(&amp;p)</code>调用为例。</p> <ol> <li>触发<code>p</code>的<code>to_proc</code>方法。</li> <li>告诉Ruby解释器，将<code>to_proc</code>方法返回的结果当做本次函数调用的<code>block</code>。</li> </ol> <p>如果同时使用了<code>&amp;</code>符号和传入了<code>block</code>给一个函数，Ruby会报错。</p> <pre><code class="ruby">capture_block(&amp;p) { puts &quot;传给一个block&quot; }
#=&gt;SyntaxError: (irb):30: both block arg and actual block given
</code></pre> <p>所以将一个Proc对象传给<code>&amp;</code>符号，它会调用Proc对象的<code>to_proc</code>方法，返回它自己，然后把它当做方法调用的<code>block</code>传递给方法。</p> <h3><code>&amp;:upcase</code>是什么?</h3> <p>知道了<code>&amp;</code>符号的作用后，我们可以看到，<code>&amp;:upcase</code>是先调用了<code>:upcase</code>对象的<code>to_proc</code>方法。</p> <p><code>:upcase</code>的<code>to_proc</code>方法实现如下:</p> <pre><code class="ruby">class Symbol
  def to_proc
    Proc.new {|obj| obj.send(self) }
  end
end
</code></pre> <p>这下结果就很清楚了，<code>Symbol#to_proc</code>会返回一个带参数的<code>Proc</code>对象，<code>Proc</code>对象所做的是为使用这个<code>Proc</code>对象的对象发送调用名字为该符号的方法。</p> </section></div><div class=block> <div id=disqus_thread></div> <div id=load_comments>Load Comments</div> </div> </div><footer><span class=muted>© Chareice. All Rights Reserved.</span><br/><span class=muted>This work is licensed under a <a href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">CC BY-NC-SA 3.0.</a></span><br/><span class=muted>赣ICP备14009574号-3</span></footer><script src="/javascripts/all.js"></script><script src="//dn-chareicecnd.qbox.me/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-39536235-1','auto');ga('send','pageview');</script> </body></html>