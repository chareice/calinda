<!DOCTYPE html><html><head><title>Docker Swarm 初体验 - Hi, I'm Chareice.</title><meta charset=UTF-8 /><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name=viewport /><link href="/images/favicon.ico" rel="shortcut icon"/><link href="/stylesheets/index.css" rel=stylesheet /><link href="//dn-chareicecnd.qbox.me/solarized_dark.css" rel=stylesheet /></head><body><header><a href="/" id=go-back-home><img alt=Home height=100 src="/images/blog_logo.png" width=100 /></a><p>Hi, I'm Chareice.</p><p>很高兴见到你</p></header><div id=container><div class=block><a href="/articles/tags/rabbitmq.html">RabbitMQ</a><a href="/articles/tags/java.html">Java</a><a href="/articles/tags/算法.html">算法</a><a href="/articles/tags/计算机科学基础.html">计算机科学基础</a><a href="/articles/tags/python.html">Python</a><a href="/articles/tags/ruby.html">Ruby</a><a href="/articles/tags/rails.html">Rails</a></div><div class=content><section class=post><header><div class=date>24 May 2016</div><h1>Docker Swarm 初体验</h1></header><div id=toc class=toc> <div id=toctitle class=title>本文目录</div> <ul class=sectlevel1> <li><a href="#_docker_swarm">1. Docker Swarm</a></li> <li><a href="#_创建swarm_manager和nodes">2. 创建Swarm manager和nodes</a></li> <li><a href="#_管理你的swarm">3. 管理你的Swarm</a></li> </ul> </div> <div class=paragraph> <p><a href="https://www.docker.com/products/docker-swarm">Docker Swarm</a>是Docker官方推出的多机Docker集群工具，它将一组独立的Docker服务抽象为一个单独的虚拟Docker服务，并且这和虚拟的Docker服务可以和几乎所有的Docker客户端兼容。</p> </div> <div class=sect1> <h2 id=_docker_swarm>1. Docker Swarm</h2> <div class=sectionbody> <div class=paragraph> <p>要安装Docker Swarm，首先得理解swarm的创建方法，要创建 swarm 网络的第一步是拉取Docker Swarm镜像，然后使用Docker来设置swarm manager和所有在swarm中运行的节点。这些方法要求你：</p> </div> <div class=ulist> <ul> <li> <p>在所有节点上打开一个和swarm manager通信的TCP端口</p> </li> <li> <p>在所有节点上安装Docker</p> </li> <li> <p>安装和管理TLS证书来保证swarm通信安全</p> </li> </ul> </div> <div class=paragraph> <p>如果是要初次体验swarm，官方推荐使用docker-machine来安装swarm。</p> </div> <div class=sect2> <h3 id="_docker_machine安装docker_swarm">1.1. Docker Machine安装Docker Swarm</h3> <div class=paragraph> <p>安装好docker-machine之后，我们尝试启动三台节点(node)。</p> </div> <div class=sect3> <h4 id="_打开终端_显示现有的虚拟机列表">1.1.1. 打开终端，显示现有的虚拟机列表。</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker-machine ls
NAME   ACTIVE   DRIVER         STATE     URL   SWARM
dev    -        vmwarefusion   Stopped</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_创建一台名叫_code_manager_code_的虚拟机">1.1.2. 创建一台名叫 <code>manager</code> 的虚拟机。</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker-machine create -d virtualbox manager
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env manager</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_创建一台虚拟机名叫_code_agent1_code">1.1.3. 创建一台虚拟机名叫 <code>agent1</code> 。</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code>➜  ~ docker-machine create -d virtualbox agent1
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent1</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_创建一台虚拟机名叫_code_agent2_code">1.1.4. 创建一台虚拟机名叫 <code>agent2</code> 。</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code>➜  ~ docker-machine create -d virtualbox agent2
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent2</code></pre> </div> </div> </div> </div> <div class=sect2> <h3 id="_创建_swarm_discovery_token">1.2. 创建 Swarm discovery token</h3> <div class=paragraph> <p>在这里，我们使用Docker Hub托管的discovery后端来为我们的集群生成一个全球唯一的discovery token。这个discovery后端仅仅用做开发和测试意图，并不是针对生产环境。稍后，当你运行swarm manager和nodes，它们会在discovery后端注册为集群的成员，这个集群正是和刚才获取到的discovery token关联的。discovery后端维护和管理该集群中的成员列表，并和swarm manager共享列表内容， swarm manager使用这个列表来给nodes分配任务。</p> </div> <div class=sect3> <h4 id="_连接到manager_docker_engine">1.2.1. 连接到manager docker engine。</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ eval $(docker-machine env manager)</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_为swarm集群创建唯一id">1.2.2. 为swarm集群创建唯一id。</h4> <div class=paragraph> <p>由于你懂的原因，这里使用alauda的镜像来替代swarm镜像。</p> </div> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker run --rm index.alauda.cn/library/swarm create
Unable to find image 'index.alauda.cn/library/swarm:latest' locally
latest: Pulling from library/swarm
4bdde9413a9d: Pull complete
281a124ed91f: Pull complete
d953790d1cd9: Pull complete
73f6bd4c8155: Pull complete
4be7977a13c8: Pull complete
a7afc66291b2: Pull complete
6abeb218f75c: Pull complete
9a6aaea664d1: Pull complete
Digest: sha256:7daa83d26095e5761252cfc0d8cb6f5e04a9443654ed3fc4395cb9ce3709730a
Status: Downloaded newer image for index.alauda.cn/library/swarm:latest
e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_复制唯一id">1.2.3. 复制唯一id。</h4> <div class=paragraph> <p>唯一ID就是上一步命令最后一行字付串。</p> </div> </div> </div> </div> </div> <div class=sect1> <h2 id="_创建swarm_manager和nodes">2. 创建Swarm manager和nodes</h2> <div class=sectionbody> <div class=paragraph> <p>这一步，你将把每一个主机连接起来，并且创建swarm manager和nodes。</p> </div> <div class=sect2> <h3 id="_查看运行中的虚拟机列表">2.1. 查看运行中的虚拟机列表。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker-machine ls
NAME      ACTIVE   DRIVER         STATE     URL                         SWARM
agent1    -        virtualbox     Running   tcp://192.168.99.101:2376
agent2    -        virtualbox     Running   tcp://192.168.99.102:2376
dev       -        vmwarefusion   Stopped
manager   *        virtualbox     Running   tcp://192.168.99.100:2376</code></pre> </div> </div> <div class=paragraph> <p>你的Docker客户端还是应当连接到manager节点。使用下面的语法在 <code>manager</code> 主机上运行一个功能为primary manager的容器。</p> </div> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker run -d -p &lt;你选择的端口号&gt;:3376 -t -v /var/lib/boot2docker:/certs:ro swarm manage -H 0.0.0.0:3376 --tlsverify --tlscacert=/certs/ca.pem --tlscert=/certs/server.pem --tlskey=/certs/server-key.pem token://e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_连接到_agent1">2.2. 连接到`agent1`。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ eval $(docker-machine env agent1)</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_在_agent1_主机上运行功能为agent的容器">2.3. 在`agent1`主机上运行功能为agent的容器。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker run -d index.alauda.cn/library/swarm:latest join --addr=$(docker-machine ip agent1):2376 token://e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_连接到_agent2_重复同样的命令_注意替换ip地址">2.4. 连接到`agent2`，重复同样的命令，注意替换IP地址。</h3> </div> </div> </div> <div class=sect1> <h2 id="_管理你的swarm">3. 管理你的Swarm</h2> <div class=sectionbody> <div class=paragraph> <p>在这里，你将连接上你创建的集群，查看swarm manager和nodes的信息，通知swarn运行容器然后检查是哪个节点运行了这个容器。</p> </div> <div class=sect2> <h3 id="_通过修改_docker_host_环境变量连接到swarm">3.1. 通过修改`DOCKER_HOST`环境变量连接到swarm。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ DOCKER_HOST=&lt;manager_ip&gt;:&lt;你选择的端口号&gt;</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_查看swarm的信息">3.2. 查看swarm的信息。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker info</code></pre> </div> </div> <div class=paragraph> <p>在这里我们可以查看到节点相关的信息。官方文档说能看到2个agent和1个master，可是我只看到了2个agent&#8230;&#8203;😓</p> </div> </div> <div class=sect2> <h3 id="_查看当前运行的容器">3.3. 查看当前运行的容器。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker ps</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_在swarm中运行容器">3.4. 在swarm中运行容器。</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">➜  ~ docker run index.alauda.cn/library/hello-world</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_使用_code_docker_ps_code_查看容器运行在哪个节点上">3.5. 使用 <code>docker ps</code> 查看容器运行在哪个节点上。</h3> <div class=paragraph> <p>默认情况下，Docker Swarm使用&#8217;spread&#8217;调度策略来运行容器，该策略会选择运行容器数量最少的host来运行容器。</p> </div> </div> </div> </div></section></div><div class=block> <div id=disqus_thread></div> <div id=load_comments>Load Comments</div> </div> </div><footer><span class=muted>© Chareice. All Rights Reserved.</span><br/><span class=muted>This work is licensed under a <a href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">CC BY-NC-SA 3.0.</a></span><br/><span class=muted>赣ICP备14009574号-3</span></footer><script src="/javascripts/all.js"></script><script src="//dn-chareicecnd.qbox.me/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-39536235-1','auto');ga('send','pageview');</script> </body></html>