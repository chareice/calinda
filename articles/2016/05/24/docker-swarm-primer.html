<!DOCTYPE html><html><head><title>Docker Swarm åˆä½“éªŒ - Hi, I'm Chareice.</title><meta charset=UTF-8 /><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name=viewport /><link href="/images/favicon.ico" rel="shortcut icon"/><link href="/stylesheets/index.css" rel=stylesheet /><link href="//dn-chareicecnd.qbox.me/solarized_dark.css" rel=stylesheet /></head><body><header><a href="/" id=go-back-home><img alt=Home height=100 src="/images/blog_logo.png" width=100 /></a><p>Hi, I'm Chareice.</p><p>å¾ˆé«˜å…´è§åˆ°ä½ </p></header><div id=container><div class=block><a href="/articles/tags/rabbitmq.html">RabbitMQ</a><a href="/articles/tags/java.html">Java</a><a href="/articles/tags/ç®—æ³•.html">ç®—æ³•</a><a href="/articles/tags/è®¡ç®—æœºç§‘å­¦åŸºç¡€.html">è®¡ç®—æœºç§‘å­¦åŸºç¡€</a><a href="/articles/tags/python.html">Python</a><a href="/articles/tags/ruby.html">Ruby</a><a href="/articles/tags/rails.html">Rails</a></div><div class=content><section class=post><header><div class=date>24 May 2016</div><h1>Docker Swarm åˆä½“éªŒ</h1></header><div id=toc class=toc> <div id=toctitle class=title>æœ¬æ–‡ç›®å½•</div> <ul class=sectlevel1> <li><a href="#_docker_swarm">1. Docker Swarm</a></li> <li><a href="#_åˆ›å»ºswarm_managerå’Œnodes">2. åˆ›å»ºSwarm managerå’Œnodes</a></li> <li><a href="#_ç®¡ç†ä½ çš„swarm">3. ç®¡ç†ä½ çš„Swarm</a></li> </ul> </div> <div class=paragraph> <p><a href="https://www.docker.com/products/docker-swarm">Docker Swarm</a>æ˜¯Dockerå®˜æ–¹æ¨å‡ºçš„å¤šæœºDockeré›†ç¾¤å·¥å…·ï¼Œå®ƒå°†ä¸€ç»„ç‹¬ç«‹çš„DockeræœåŠ¡æŠ½è±¡ä¸ºä¸€ä¸ªå•ç‹¬çš„è™šæ‹ŸDockeræœåŠ¡ï¼Œå¹¶ä¸”è¿™å’Œè™šæ‹Ÿçš„DockeræœåŠ¡å¯ä»¥å’Œå‡ ä¹æ‰€æœ‰çš„Dockerå®¢æˆ·ç«¯å…¼å®¹ã€‚</p> </div> <div class=sect1> <h2 id=_docker_swarm>1. Docker Swarm</h2> <div class=sectionbody> <div class=paragraph> <p>è¦å®‰è£…Docker Swarmï¼Œé¦–å…ˆå¾—ç†è§£swarmçš„åˆ›å»ºæ–¹æ³•ï¼Œè¦åˆ›å»º swarm ç½‘ç»œçš„ç¬¬ä¸€æ­¥æ˜¯æ‹‰å–Docker Swarmé•œåƒï¼Œç„¶åä½¿ç”¨Dockeræ¥è®¾ç½®swarm managerå’Œæ‰€æœ‰åœ¨swarmä¸­è¿è¡Œçš„èŠ‚ç‚¹ã€‚è¿™äº›æ–¹æ³•è¦æ±‚ä½ ï¼š</p> </div> <div class=ulist> <ul> <li> <p>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰“å¼€ä¸€ä¸ªå’Œswarm manageré€šä¿¡çš„TCPç«¯å£</p> </li> <li> <p>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Docker</p> </li> <li> <p>å®‰è£…å’Œç®¡ç†TLSè¯ä¹¦æ¥ä¿è¯swarmé€šä¿¡å®‰å…¨</p> </li> </ul> </div> <div class=paragraph> <p>å¦‚æœæ˜¯è¦åˆæ¬¡ä½“éªŒswarmï¼Œå®˜æ–¹æ¨èä½¿ç”¨docker-machineæ¥å®‰è£…swarmã€‚</p> </div> <div class=sect2> <h3 id="_docker_machineå®‰è£…docker_swarm">1.1. Docker Machineå®‰è£…Docker Swarm</h3> <div class=paragraph> <p>å®‰è£…å¥½docker-machineä¹‹åï¼Œæˆ‘ä»¬å°è¯•å¯åŠ¨ä¸‰å°èŠ‚ç‚¹(node)ã€‚</p> </div> <div class=sect3> <h4 id="_æ‰“å¼€ç»ˆç«¯_æ˜¾ç¤ºç°æœ‰çš„è™šæ‹Ÿæœºåˆ—è¡¨">1.1.1. æ‰“å¼€ç»ˆç«¯ï¼Œæ˜¾ç¤ºç°æœ‰çš„è™šæ‹Ÿæœºåˆ—è¡¨ã€‚</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker-machine ls
NAME   ACTIVE   DRIVER         STATE     URL   SWARM
dev    -        vmwarefusion   Stopped</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_åˆ›å»ºä¸€å°åå«_code_manager_code_çš„è™šæ‹Ÿæœº">1.1.2. åˆ›å»ºä¸€å°åå« <code>manager</code> çš„è™šæ‹Ÿæœºã€‚</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker-machine create -d virtualbox manager
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env manager</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå«_code_agent1_code">1.1.3. åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå« <code>agent1</code> ã€‚</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code>âœ  ~ docker-machine create -d virtualbox agent1
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent1</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå«_code_agent2_code">1.1.4. åˆ›å»ºä¸€å°è™šæ‹Ÿæœºåå« <code>agent2</code> ã€‚</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code>âœ  ~ docker-machine create -d virtualbox agent2
Running pre-create checks...
Creating machine...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env agent2</code></pre> </div> </div> </div> </div> <div class=sect2> <h3 id="_åˆ›å»º_swarm_discovery_token">1.2. åˆ›å»º Swarm discovery token</h3> <div class=paragraph> <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨Docker Hubæ‰˜ç®¡çš„discoveryåç«¯æ¥ä¸ºæˆ‘ä»¬çš„é›†ç¾¤ç”Ÿæˆä¸€ä¸ªå…¨çƒå”¯ä¸€çš„discovery tokenã€‚è¿™ä¸ªdiscoveryåç«¯ä»…ä»…ç”¨åšå¼€å‘å’Œæµ‹è¯•æ„å›¾ï¼Œå¹¶ä¸æ˜¯é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒã€‚ç¨åï¼Œå½“ä½ è¿è¡Œswarm managerå’Œnodesï¼Œå®ƒä»¬ä¼šåœ¨discoveryåç«¯æ³¨å†Œä¸ºé›†ç¾¤çš„æˆå‘˜ï¼Œè¿™ä¸ªé›†ç¾¤æ­£æ˜¯å’Œåˆšæ‰è·å–åˆ°çš„discovery tokenå…³è”çš„ã€‚discoveryåç«¯ç»´æŠ¤å’Œç®¡ç†è¯¥é›†ç¾¤ä¸­çš„æˆå‘˜åˆ—è¡¨ï¼Œå¹¶å’Œswarm managerå…±äº«åˆ—è¡¨å†…å®¹ï¼Œ swarm managerä½¿ç”¨è¿™ä¸ªåˆ—è¡¨æ¥ç»™nodesåˆ†é…ä»»åŠ¡ã€‚</p> </div> <div class=sect3> <h4 id="_è¿æ¥åˆ°manager_docker_engine">1.2.1. è¿æ¥åˆ°manager docker engineã€‚</h4> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ eval $(docker-machine env manager)</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_ä¸ºswarmé›†ç¾¤åˆ›å»ºå”¯ä¸€id">1.2.2. ä¸ºswarmé›†ç¾¤åˆ›å»ºå”¯ä¸€idã€‚</h4> <div class=paragraph> <p>ç”±äºä½ æ‡‚çš„åŸå› ï¼Œè¿™é‡Œä½¿ç”¨alaudaçš„é•œåƒæ¥æ›¿ä»£swarmé•œåƒã€‚</p> </div> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker run --rm index.alauda.cn/library/swarm create
Unable to find image 'index.alauda.cn/library/swarm:latest' locally
latest: Pulling from library/swarm
4bdde9413a9d: Pull complete
281a124ed91f: Pull complete
d953790d1cd9: Pull complete
73f6bd4c8155: Pull complete
4be7977a13c8: Pull complete
a7afc66291b2: Pull complete
6abeb218f75c: Pull complete
9a6aaea664d1: Pull complete
Digest: sha256:7daa83d26095e5761252cfc0d8cb6f5e04a9443654ed3fc4395cb9ce3709730a
Status: Downloaded newer image for index.alauda.cn/library/swarm:latest
e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect3> <h4 id="_å¤åˆ¶å”¯ä¸€id">1.2.3. å¤åˆ¶å”¯ä¸€idã€‚</h4> <div class=paragraph> <p>å”¯ä¸€IDå°±æ˜¯ä¸Šä¸€æ­¥å‘½ä»¤æœ€åä¸€è¡Œå­—ä»˜ä¸²ã€‚</p> </div> </div> </div> </div> </div> <div class=sect1> <h2 id="_åˆ›å»ºswarm_managerå’Œnodes">2. åˆ›å»ºSwarm managerå’Œnodes</h2> <div class=sectionbody> <div class=paragraph> <p>è¿™ä¸€æ­¥ï¼Œä½ å°†æŠŠæ¯ä¸€ä¸ªä¸»æœºè¿æ¥èµ·æ¥ï¼Œå¹¶ä¸”åˆ›å»ºswarm managerå’Œnodesã€‚</p> </div> <div class=sect2> <h3 id="_æŸ¥çœ‹è¿è¡Œä¸­çš„è™šæ‹Ÿæœºåˆ—è¡¨">2.1. æŸ¥çœ‹è¿è¡Œä¸­çš„è™šæ‹Ÿæœºåˆ—è¡¨ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker-machine ls
NAME      ACTIVE   DRIVER         STATE     URL                         SWARM
agent1    -        virtualbox     Running   tcp://192.168.99.101:2376
agent2    -        virtualbox     Running   tcp://192.168.99.102:2376
dev       -        vmwarefusion   Stopped
manager   *        virtualbox     Running   tcp://192.168.99.100:2376</code></pre> </div> </div> <div class=paragraph> <p>ä½ çš„Dockerå®¢æˆ·ç«¯è¿˜æ˜¯åº”å½“è¿æ¥åˆ°managerèŠ‚ç‚¹ã€‚ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•åœ¨ <code>manager</code> ä¸»æœºä¸Šè¿è¡Œä¸€ä¸ªåŠŸèƒ½ä¸ºprimary managerçš„å®¹å™¨ã€‚</p> </div> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker run -d -p &lt;ä½ é€‰æ‹©çš„ç«¯å£å·&gt;:3376 -t -v /var/lib/boot2docker:/certs:ro swarm manage -H 0.0.0.0:3376 --tlsverify --tlscacert=/certs/ca.pem --tlscert=/certs/server.pem --tlskey=/certs/server-key.pem token://e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_è¿æ¥åˆ°_agent1">2.2. è¿æ¥åˆ°`agent1`ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ eval $(docker-machine env agent1)</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_åœ¨_agent1_ä¸»æœºä¸Šè¿è¡ŒåŠŸèƒ½ä¸ºagentçš„å®¹å™¨">2.3. åœ¨`agent1`ä¸»æœºä¸Šè¿è¡ŒåŠŸèƒ½ä¸ºagentçš„å®¹å™¨ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker run -d index.alauda.cn/library/swarm:latest join --addr=$(docker-machine ip agent1):2376 token://e93a2623b23255f245ee82fb9617320e</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_è¿æ¥åˆ°_agent2_é‡å¤åŒæ ·çš„å‘½ä»¤_æ³¨æ„æ›¿æ¢ipåœ°å€">2.4. è¿æ¥åˆ°`agent2`ï¼Œé‡å¤åŒæ ·çš„å‘½ä»¤ï¼Œæ³¨æ„æ›¿æ¢IPåœ°å€ã€‚</h3> </div> </div> </div> <div class=sect1> <h2 id="_ç®¡ç†ä½ çš„swarm">3. ç®¡ç†ä½ çš„Swarm</h2> <div class=sectionbody> <div class=paragraph> <p>åœ¨è¿™é‡Œï¼Œä½ å°†è¿æ¥ä¸Šä½ åˆ›å»ºçš„é›†ç¾¤ï¼ŒæŸ¥çœ‹swarm managerå’Œnodesçš„ä¿¡æ¯ï¼Œé€šçŸ¥swarnè¿è¡Œå®¹å™¨ç„¶åæ£€æŸ¥æ˜¯å“ªä¸ªèŠ‚ç‚¹è¿è¡Œäº†è¿™ä¸ªå®¹å™¨ã€‚</p> </div> <div class=sect2> <h3 id="_é€šè¿‡ä¿®æ”¹_docker_host_ç¯å¢ƒå˜é‡è¿æ¥åˆ°swarm">3.1. é€šè¿‡ä¿®æ”¹`DOCKER_HOST`ç¯å¢ƒå˜é‡è¿æ¥åˆ°swarmã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ DOCKER_HOST=&lt;manager_ip&gt;:&lt;ä½ é€‰æ‹©çš„ç«¯å£å·&gt;</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_æŸ¥çœ‹swarmçš„ä¿¡æ¯">3.2. æŸ¥çœ‹swarmçš„ä¿¡æ¯ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker info</code></pre> </div> </div> <div class=paragraph> <p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯ã€‚å®˜æ–¹æ–‡æ¡£è¯´èƒ½çœ‹åˆ°2ä¸ªagentå’Œ1ä¸ªmasterï¼Œå¯æ˜¯æˆ‘åªçœ‹åˆ°äº†2ä¸ªagent&#8230;&#8203;ğŸ˜“</p> </div> </div> <div class=sect2> <h3 id="_æŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨">3.3. æŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker ps</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_åœ¨swarmä¸­è¿è¡Œå®¹å™¨">3.4. åœ¨swarmä¸­è¿è¡Œå®¹å™¨ã€‚</h3> <div class=listingblock> <div class=content> <pre class="CodeRay highlight"><code data-lang="text">âœ  ~ docker run index.alauda.cn/library/hello-world</code></pre> </div> </div> </div> <div class=sect2> <h3 id="_ä½¿ç”¨_code_docker_ps_code_æŸ¥çœ‹å®¹å™¨è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Š">3.5. ä½¿ç”¨ <code>docker ps</code> æŸ¥çœ‹å®¹å™¨è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚</h3> <div class=paragraph> <p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker Swarmä½¿ç”¨&#8217;spread&#8217;è°ƒåº¦ç­–ç•¥æ¥è¿è¡Œå®¹å™¨ï¼Œè¯¥ç­–ç•¥ä¼šé€‰æ‹©è¿è¡Œå®¹å™¨æ•°é‡æœ€å°‘çš„hostæ¥è¿è¡Œå®¹å™¨ã€‚</p> </div> </div> </div> </div></section></div><div class=block> <div id=disqus_thread></div> <div id=load_comments>Load Comments</div> </div> </div><footer><span class=muted>Â© Chareice. All Rights Reserved.</span><br/><span class=muted>This work is licensed under a <a href="//creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">CC BY-NC-SA 3.0.</a></span><br/><span class=muted>èµ£ICPå¤‡14009574å·-3</span></footer><script src="/javascripts/all.js"></script><script src="//dn-chareicecnd.qbox.me/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-39536235-1','auto');ga('send','pageview');</script> </body></html>